# Doer IAM — Keycloakify Theme Developer Guide

This document explains everything you need to know to understand, modify, and extend
the Keycloak login themes for the Doer platform.

---

## Table of Contents

1. [What Is This Project?](#1-what-is-this-project)
2. [Background: How Keycloak Themes Work](#2-background-how-keycloak-themes-work)
3. [Background: What Keycloakify Does](#3-background-what-keycloakify-does)
4. [Key Terminology](#4-key-terminology)
5. [Project Structure](#5-project-structure)
6. [File-by-File Walkthrough](#6-file-by-file-walkthrough)
7. [Theme Variants Explained](#7-theme-variants-explained)
8. [CSS Architecture](#8-css-architecture)
9. [Internationalization (i18n)](#9-internationalization-i18n)
10. [Development Workflow](#10-development-workflow)
11. [Build and Deploy](#11-build-and-deploy)
12. [How to: Common Tasks](#12-how-to-common-tasks)
13. [Troubleshooting](#13-troubleshooting)
14. [Reference: Keycloak Pages](#14-reference-keycloak-pages)
15. [Reference: kcContext](#15-reference-kccontext)
16. [Reference: CSS Selectors](#16-reference-css-selectors)

---

## 1. What Is This Project?

This is a **React + TypeScript** project that produces custom-branded login pages
for Keycloak. Instead of Keycloak's default blue login form, users of Doer products
(Doer Visa, Doer Admin, future products) see login pages with our own colors,
branding, and text.

The project produces a single `.jar` file containing multiple **theme variants** —
one per product. Each Keycloak client (doer-visa, doer-admin, etc.) is assigned its
own variant, so users see different branding depending on which product they're
logging into.

**Current variants:**

| Variant Name | Client          | Color Palette        | Purpose              |
|-------------|-----------------|----------------------|----------------------|
| `doer-visa` | doer-visa       | Teal/green gradient  | Visa services portal |
| `doer-admin`| doer-admin      | Dark blue gradient   | Platform admin panel |

---

## 2. Background: How Keycloak Themes Work

Keycloak handles all authentication UI (login, register, forgot password, MFA, etc.)
by itself. It renders these pages using "themes."

**Without Keycloakify**, themes are `.ftl` files (FreeMarker Template Language) — an
old-school Java server-side templating engine. You write HTML with `${variable}`
placeholders, and Keycloak fills in the values server-side before sending HTML to the
browser.

**The problem:** FreeMarker templates are hard to work with. No component system, no
TypeScript, no hot-reload, no design tooling. This is where Keycloakify comes in.

**How themes are packaged:**
- Themes are distributed as `.jar` files (Java archive — essentially a `.zip` file).
- You place the JAR in Keycloak's `providers/` directory.
- After running `kc.sh build`, Keycloak discovers the theme and makes it available in
  the admin console under Realm Settings > Themes or per-client in Client Settings.

---

## 3. Background: What Keycloakify Does

Keycloakify bridges the gap between "modern React development" and "Keycloak's
FreeMarker theme system." Here's what it does:

1. **At development time:** You write React components. Keycloakify provides a
   `kcContext` object that simulates the data Keycloak would normally pass to its
   FreeMarker templates — things like form field values, error messages, the current
   locale, social login providers, etc.

2. **At build time:** Keycloakify takes your compiled React app and wraps it in the
   FreeMarker template structure that Keycloak expects. The output is a `.jar` file
   you can drop into Keycloak's `providers/` directory.

3. **At runtime:** When a user hits a Keycloak login page, Keycloak serves the HTML
   generated by Keycloakify. This HTML includes a `<script>` tag that loads your
   React bundle. The React app reads the `kcContext` object (which Keycloakify
   injected into `window.kcContext` from the server-side data) and renders the
   appropriate page.

**In short:** You develop with React + CSS. Keycloakify handles the plumbing to make
it work inside Keycloak.

---

## 4. Key Terminology

| Term | Definition |
|------|-----------|
| **Theme** | A set of files that control how Keycloak's pages look (login, register, reset password, etc.). |
| **Theme Variant** | A named variation of a theme. One JAR can contain multiple variants (e.g., `doer-visa` and `doer-admin`). Each variant appears as a separate option in Keycloak's theme dropdown. |
| **Theme Type** | Keycloak has different types: `login` (authentication pages), `account` (user self-service), `email` (email templates), `admin` (admin console). We only customize `login`. |
| **`kcContext`** | A JavaScript object injected by Keycloakify into `window.kcContext`. It contains all the data Keycloak passes to the theme: page ID, form data, error messages, locale, CSRF tokens, social providers, etc. |
| **`pageId`** | A string like `"login.ftl"`, `"register.ftl"`, `"login-reset-password.ftl"` that identifies which Keycloak page is being rendered. Each page has its own set of data in `kcContext`. |
| **`themeName`** | Available on `kcContext.themeName`. Tells your React code which variant is active (e.g., `"doer-visa"` or `"doer-admin"`), so you can conditionally apply styles or text. |
| **Ejecting** | Keycloakify ships default React components for every Keycloak page. "Ejecting" means copying a default component into your project so you can customize it. If you don't eject, the default is used. |
| **FreeMarker / .ftl** | Keycloak's native server-side template format. You never write FreeMarker with Keycloakify — it generates these files for you. |
| **JAR** | Java Archive. The packaging format for Keycloak themes. Built by Maven under the hood (Keycloakify handles this automatically). |
| **`kc.gen.tsx`** | Auto-generated file in `src/`. Contains TypeScript types derived from your `vite.config.ts` (theme names, environment variables). **Never edit this file manually.** |
| **Storybook** | A tool for developing and previewing UI components in isolation (without running Keycloak). You can see how each login page looks with mock data. |
| **`doUseDefaultCss`** | A boolean prop on Keycloakify's `DefaultPage` component. When `true`, Keycloak's original PatternFly CSS is loaded as a base, and your CSS overrides it. When `false`, you start from a blank slate. |

---

## 5. Project Structure

```
themes/keycloakify/
├── .storybook/                  # Storybook configuration
│   ├── main.ts                  #   Storybook entry config
│   ├── preview.ts               #   Storybook decorators
│   └── preview-head.html        #   Extra HTML injected into Storybook previews
│
├── public/                      # Static assets (favicons, images)
│   └── keycloakify-dev-resources/  # DO NOT EDIT — auto-generated for Storybook
│
├── src/
│   ├── main.tsx                 # App entry point (only used in dev/Storybook)
│   ├── kc.gen.tsx               # AUTO-GENERATED — TypeScript types for theme names
│   ├── vite-env.d.ts            # Vite TypeScript declarations
│   │
│   └── login/                   # Login theme source code
│       ├── KcPage.tsx           # ** MAIN FILE ** — Page router + CSS loading
│       ├── KcContext.ts         # TypeScript types for kcContext
│       ├── KcPageStory.tsx      # Storybook mock helpers
│       ├── i18n.ts              # Internationalization (custom text per variant)
│       ├── doer-base.css        # Shared styles (layout, buttons, inputs)
│       ├── doer-visa.css        # doer-visa variant (teal colors, logo, branding)
│       └── doer-admin.css       # doer-admin variant (blue colors, logo, branding)
│
├── dist/                        # Vite build output (intermediate, gitignored)
├── dist_keycloak/               # Final JAR files (gitignored)
│   ├── keycloak-theme-for-kc-22-to-25.jar
│   └── keycloak-theme-for-kc-all-other-versions.jar   # ← Use this for Keycloak 26
│
├── vite.config.ts               # Vite + Keycloakify plugin config (theme names here)
├── tsconfig.json                # TypeScript configuration
├── tsconfig.node.json           # TypeScript config for Vite itself
├── package.json                 # Dependencies and scripts
├── index.html                   # HTML template (dev mode only)
└── DEVELOPER-GUIDE.md           # This file
```

---

## 6. File-by-File Walkthrough

### `vite.config.ts` — Build Configuration

```ts
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import { keycloakify } from "keycloakify/vite-plugin";

export default defineConfig({
    plugins: [
        react(),
        keycloakify({
            themeName: ["doer-visa", "doer-admin"],   // ← Theme variant names
            accountThemeImplementation: "none",        // ← We don't customize account pages
        })
    ]
});
```

**This is the most important configuration file.** The `themeName` array defines what
variants exist. Changing this array (adding/removing names) affects:
- What shows up in Keycloak's theme dropdown
- The TypeScript union type `ThemeName` in `kc.gen.tsx`
- What `kcContext.themeName` can be at runtime

After changing `themeName`, run `npx keycloakify update-kc-gen` to regenerate types.


### `src/kc.gen.tsx` — Auto-Generated Types

```ts
export type ThemeName = "doer-visa" | "doer-admin";
export const themeNames: ThemeName[] = ["doer-visa", "doer-admin"];
```

**Never edit this file.** It is regenerated automatically by `npx keycloakify update-kc-gen`
(which also runs during `npm run build`). It derives its content from `vite.config.ts`.


### `src/login/KcPage.tsx` — The Page Router (Core File)

This is the heart of the theme. When Keycloak renders a page, the React app starts
and `KcPage` receives the `kcContext`. It does two things:

1. **Loads variant-specific CSS** based on `kcContext.themeName`
2. **Routes to the correct page component** based on `kcContext.pageId`

```ts
export default function KcPage(props: { kcContext: KcContext }) {
    const { kcContext } = props;
    const { i18n } = useI18n({ kcContext });

    return (
        <Suspense>
            {(() => {
                // 1. Load the right CSS for this variant
                switch (kcContext.themeName) {
                    case "doer-visa":
                        import("./doer-visa.css");
                        break;
                    case "doer-admin":
                        import("./doer-admin.css");
                        break;
                }

                // 2. Render the page
                switch (kcContext.pageId) {
                    // If you eject a page, add a case here:
                    // case "login.ftl":
                    //     return <Login kcContext={kcContext} i18n={i18n} />;

                    default:
                        // All pages use the Keycloakify default renderer
                        return (
                            <DefaultPage
                                kcContext={kcContext}
                                i18n={i18n}
                                classes={classes}
                                Template={Template}
                                doUseDefaultCss={true}
                                UserProfileFormFields={UserProfileFormFields}
                                doMakeUserConfirmPassword={doMakeUserConfirmPassword}
                            />
                        );
                }
            })()}
        </Suspense>
    );
}
```

The `doUseDefaultCss={true}` line means Keycloak's original CSS is loaded first, and
our CSS files override it. If you want to start from scratch (no PatternFly base),
set this to `false` — but you'll need to style everything yourself.


### `src/login/KcContext.ts` — Type Definitions

Defines the TypeScript type of `kcContext`. You can extend it to include custom
properties that Keycloak passes to your theme (via environment variables, for
example).

```ts
export type KcContext = ExtendKcContext<KcContextExtension, KcContextExtensionPerPage>;
```


### `src/login/i18n.ts` — Internationalization

Defines custom text strings per variant. Keycloak has built-in translation keys
(like `loginAccountTitle`, `doLogIn`, `noAccount`). You can override any of them
with variant-specific text.

```ts
const { useI18n, ofTypeI18n } = i18nBuilder
    .withThemeName<ThemeName>()
    .withCustomTranslations({
        en: {
            loginAccountTitle: {
                "doer-visa": "Sign in to Doer Visa",
                "doer-admin": "Sign in to Doer Admin"
            }
        }
    })
    .build();
```

Each key maps to a Keycloak message property. The value is an object with one entry
per theme variant.


### `src/login/doer-base.css` — Shared Base Styles

CSS applied to all variants. Uses CSS custom properties (`--doer-primary`, etc.)
that are defined in each variant's CSS file. This file contains:
- Login card layout and border radius
- Form input styling
- Button styling (using `--doer-primary` color)
- Social login button styling
- Alert/error message styling
- Responsive breakpoints


### `src/login/doer-visa.css` and `doer-admin.css` — Variant Styles

Each file defines the CSS custom properties (colors, gradients) and any
variant-specific overrides (logo, branding text).

```css
:root {
    --doer-primary: #0d9488;         /* Main brand color */
    --doer-primary-hover: #0f766e;   /* Hover state */
    --doer-primary-ring: rgba(...);  /* Focus ring */
    --doer-bg-gradient: linear-gradient(...);  /* Page background */
    --doer-accent: #14b8a6;          /* Accent color for logo */
}
```

The base CSS references these variables, so changing them in a variant file
automatically recolors everything.


### `src/login/KcPageStory.tsx` — Storybook Helpers

Provides the `getKcContextMock()` function and `createKcPageStory()` factory for
Storybook stories. Used to render individual pages in isolation with mock data.


### `src/main.tsx` — Dev Entry Point

Only used when running `npm run dev` (Vite dev server) or Storybook. In production,
Keycloakify generates its own entry point. Contains a commented block you can
uncomment to preview pages during development.

---

## 7. Theme Variants Explained

### How Variants Work

All variants are compiled into a single JAR. Inside the JAR, the file structure looks
like:

```
META-INF/keycloak-themes.json        ← lists: "doer-visa", "doer-admin"
theme/doer-visa/login/               ← React bundle + assets for doer-visa
theme/doer-admin/login/              ← React bundle + assets for doer-admin
```

Each variant shares the same React bundle but loads different CSS at runtime based on
`kcContext.themeName`.


### How Keycloak Picks the Variant

1. When a user navigates to a Keycloak login page, the URL contains a `client_id`
   parameter (e.g., `?client_id=doer-visa`).
2. Keycloak looks up the client's `login_theme` attribute.
3. If it's set to `"doer-visa"`, Keycloak serves files from `theme/doer-visa/login/`.
4. The React app boots, reads `kcContext.themeName` (which is `"doer-visa"`), and
   loads the corresponding CSS.


### Adding a New Variant

See [Section 12.1](#121-add-a-new-product-theme) below.

---

## 8. CSS Architecture

The CSS is layered in three levels:

```
Level 1: Keycloak's built-in PatternFly CSS (loaded because doUseDefaultCss=true)
    ↓ overridden by
Level 2: doer-base.css (shared Doer styling — layout, buttons, inputs)
    ↓ overridden by
Level 3: doer-{variant}.css (per-variant colors, logos, branding text)
```

### CSS Custom Properties (Design Tokens)

Every variant must define these CSS variables in `:root`:

| Variable | Purpose | Example |
|----------|---------|---------|
| `--doer-primary` | Main brand color (buttons, links, focus rings) | `#0d9488` |
| `--doer-primary-hover` | Button hover state | `#0f766e` |
| `--doer-primary-ring` | Focus ring (semi-transparent) | `rgba(13, 148, 136, 0.2)` |
| `--doer-bg-gradient` | Full-page background gradient | `linear-gradient(135deg, ...)` |
| `--doer-accent` | Secondary color (logo gradient, highlights) | `#14b8a6` |

### Why `!important`?

Many rules use `!important` because they need to override Keycloak's built-in
PatternFly CSS, which has high specificity. If you set `doUseDefaultCss={false}`,
you can remove the `!important` declarations.

---

## 9. Internationalization (i18n)

Keycloakify provides a full i18n system based on Keycloak's message properties.

### How it works

Keycloak has hundreds of translation keys (e.g., `loginAccountTitle`, `doLogIn`,
`usernameOrEmail`, `password`, `doForgotPassword`, `noAccount`, `doRegister`). Each
key has a default English value and translations for 30+ languages.

In `src/login/i18n.ts`, you can override any key. The override can be:
- A plain string (same value for all variants)
- An object keyed by variant name (different text per product)

### Example: Adding a new translation override

```ts
.withCustomTranslations({
    en: {
        doForgotPassword: {
            "doer-visa": "Forgot your password?",
            "doer-admin": "Reset admin password"
        },
        // You can also use a plain string for all variants:
        rememberMe: "Keep me signed in"
    },
    // Add other languages:
    bn: {
        loginAccountTitle: {
            "doer-visa": "ডোয়ার ভিসায় সাইন ইন করুন",
            "doer-admin": "ডোয়ার অ্যাডমিনে সাইন ইন করুন"
        }
    }
})
```

### Finding translation key names

The full list of Keycloak's message property keys is available at:
`node_modules/keycloakify/src/login/i18n/messages_defaultSet/en.ts`

Or search the Keycloak source code for `messages_en.properties`.

---

## 10. Development Workflow

### Prerequisites

- **Node.js** 18+ or 20+ (we use 20)
- **npm** (package manager)
- **Maven** 3.1+ (for JAR packaging — installed at `~/.local/share/maven`)
- **Java** 7+ (comes with our Keycloak installation)

Ensure Maven is on your PATH:
```bash
export PATH="$HOME/.local/bin:$PATH"
```

### Option A: Storybook (Fastest Iteration)

Storybook lets you preview every Keycloak page with mock data. No Keycloak needed.

```bash
cd themes/keycloakify
npm run storybook
```

Opens at http://localhost:6006. To add a story for a specific page:
```bash
npx keycloakify add-story
# Select "login" theme type, then pick the page (e.g., login.ftl)
```

This creates a `.stories.tsx` file you can view in Storybook.


### Option B: Vite Dev Server

```bash
cd themes/keycloakify
npm run dev
```

Opens at http://localhost:5173. By default, it shows "No Keycloak Context" because
there's no `kcContext`. To preview a page, uncomment the block in `src/main.tsx`:

```ts
import { getKcContextMock } from "./login/KcPageStory";

if (import.meta.env.DEV) {
    window.kcContext = getKcContextMock({
        pageId: "login.ftl",   // ← Change to the page you want to preview
        overrides: {}
    });
}
```

**Remember to comment this back** before building for production, or it will inflate
your bundle size.


### Option C: Real Keycloak (Full Integration Test)

Build the JAR and deploy it to your local Keycloak:

```bash
# From the IAM project root:
bash scripts/deploy-theme.sh

# Then restart Keycloak:
# 1. Kill the running instance
kill $(pgrep -f "kc.sh")
# 2. Wait a moment, then start it again
keycloak-26.5.4/bin/kc.sh start-dev
```

Then navigate to a login page:
```
http://localhost:8080/realms/doer/protocol/openid-connect/auth?\
  client_id=doer-visa&\
  response_type=code&\
  redirect_uri=http://localhost:3001/callback&\
  scope=openid&\
  code_challenge=<PKCE_CHALLENGE>&\
  code_challenge_method=S256
```

---

## 11. Build and Deploy

### Build the JAR

```bash
cd themes/keycloakify
npm run build-keycloak-theme
```

This runs three steps:
1. `tsc` — TypeScript compilation (type checking)
2. `vite build` — Bundles React app into static files in `dist/`
3. `keycloakify build` — Wraps the Vite output in FreeMarker templates and packages
   into JARs in `dist_keycloak/`

**Output:**
```
dist_keycloak/
├── keycloak-theme-for-kc-22-to-25.jar             ← For Keycloak 22-25
└── keycloak-theme-for-kc-all-other-versions.jar    ← For Keycloak 11-21 AND 26+ ← USE THIS
```

### Deploy to Keycloak

**Automated (recommended):**
```bash
bash scripts/deploy-theme.sh
# Then restart Keycloak
```

**Manual:**
```bash
# 1. Copy the JAR
cp dist_keycloak/keycloak-theme-for-kc-all-other-versions.jar \
   ../../keycloak-26.5.4/providers/doer-themes.jar

# 2. Rebuild Keycloak (registers the new provider)
../../keycloak-26.5.4/bin/kc.sh build

# 3. Restart Keycloak
#    (stop the running instance first, then start again)
../../keycloak-26.5.4/bin/kc.sh start-dev
```

**Why `kc.sh build`?** Keycloak uses Quarkus under the hood. When you add or update
a provider JAR, Keycloak needs to rebuild its internal dependency graph. Without this
step, the theme won't be recognized.


### Assign Theme to a Client

In Keycloak Admin Console (http://localhost:8080/admin):
1. Select the `doer` realm
2. Go to **Clients** > select the client (e.g., `doer-visa`)
3. Scroll to **Login settings** section
4. Set **Login theme** dropdown to the variant name (e.g., `doer-visa`)
5. Save

Or via the Admin REST API:
```bash
# Get an admin token
TOKEN=$(curl -s http://localhost:8080/realms/doer/protocol/openid-connect/token \
  -d "grant_type=client_credentials" \
  -d "client_id=doer-auth-svc" \
  -d "client_secret=BKvf27gj5wIIzWXsksHxdVHYJ5RqUV2q" \
  | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])")

# Get the client UUID
CLIENT_UUID=$(curl -s "http://localhost:8080/admin/realms/doer/clients?clientId=doer-visa" \
  -H "Authorization: Bearer $TOKEN" \
  | python3 -c "import sys,json; print(json.load(sys.stdin)[0]['id'])")

# Set the login theme
curl -X PUT "http://localhost:8080/admin/realms/doer/clients/$CLIENT_UUID" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"id\":\"$CLIENT_UUID\",\"clientId\":\"doer-visa\",\"attributes\":{\"login_theme\":\"doer-visa\"}}"
```

---

## 12. How to: Common Tasks

### 12.1 Add a New Product Theme

Example: adding a `doer-school` variant.

**Step 1: Register the variant name**

Edit `vite.config.ts`:
```ts
keycloakify({
    themeName: ["doer-visa", "doer-admin", "doer-school"],  // ← add here
    accountThemeImplementation: "none",
})
```

**Step 2: Regenerate types**
```bash
npx keycloakify update-kc-gen
```

This updates `src/kc.gen.tsx` so that `ThemeName` includes `"doer-school"`.

**Step 3: Create the variant CSS file**

Create `src/login/doer-school.css`:
```css
:root {
    --doer-primary: #7c3aed;          /* Purple */
    --doer-primary-hover: #6d28d9;
    --doer-primary-ring: rgba(124, 58, 237, 0.2);
    --doer-bg-gradient: linear-gradient(135deg, #4c1d95 0%, #2e1065 50%, #1e1b4b 100%);
    --doer-accent: #8b5cf6;
}

#kc-header-wrapper::before {
    content: '';
    display: block;
    width: 64px;
    height: 64px;
    margin: 0 auto 0.75rem;
    background: linear-gradient(135deg, var(--doer-primary), var(--doer-accent));
    border-radius: 16px;
}

.card-pf::after {
    content: 'Doer School Management';
    display: block;
    text-align: center;
    margin-top: 1.5rem;
    font-size: 0.75rem;
    color: #9ca3af;
    letter-spacing: 0.05em;
}
```

**Step 4: Load it in KcPage.tsx**

Add a case in the `switch (kcContext.themeName)` block in `src/login/KcPage.tsx`:
```ts
case "doer-school":
    import("./doer-school.css");
    break;
```

**Step 5: Add translations (optional)**

In `src/login/i18n.ts`, add entries for the new variant:
```ts
loginAccountTitle: {
    "doer-visa": "Sign in to Doer Visa",
    "doer-admin": "Sign in to Doer Admin",
    "doer-school": "Sign in to Doer School"   // ← add
}
```

**Step 6: Build, deploy, assign**
```bash
npm run build-keycloak-theme
bash ../../scripts/deploy-theme.sh
# Restart Keycloak, then assign "doer-school" theme to the doer-school client
```


### 12.2 Customize a Specific Page (Ejecting)

By default, all pages use Keycloakify's `DefaultPage` component. To fully customize
a page (e.g., the login page), you "eject" it — meaning you copy the source code of
the default component into your project and modify it.

**Step 1: Run the eject command**
```bash
npx keycloakify eject-page
```

This opens an interactive prompt:
1. Select theme type: `login`
2. Select page: `login.ftl`

It creates a file like `src/login/pages/Login.tsx` with the full source code.

**Step 2: Import and use it in KcPage.tsx**

```ts
import { lazy } from "react";
const Login = lazy(() => import("./pages/Login"));

// Inside the switch (kcContext.pageId):
case "login.ftl":
    return <Login kcContext={kcContext} i18n={i18n} Template={Template} classes={classes} />;
```

**Step 3: Edit the component**

Now you have full control over the HTML structure, logic, and styling of that page.

**Common pages you might want to eject:**
- `login.ftl` — The main login form
- `register.ftl` — Registration page
- `login-reset-password.ftl` — Forgot password
- `login-otp.ftl` — MFA/OTP input
- `login-config-totp.ftl` — TOTP setup
- `Template.tsx` — The layout wrapper (header, footer) shared by all pages


### 12.3 Add a Logo Image

**Step 1:** Place your logo in `public/` (e.g., `public/doer-visa-logo.svg`)

**Step 2:** Reference it in the variant CSS:

```css
#kc-header-wrapper::before {
    content: '';
    display: block;
    width: 120px;
    height: 48px;
    margin: 0 auto 0.75rem;
    background: url('/doer-visa-logo.svg') no-repeat center;
    background-size: contain;
    border-radius: 0;  /* Remove the rounded square placeholder */
}
```

Files in `public/` are served at the root URL. Keycloakify includes them in the
JAR's resources directory.


### 12.4 Change Colors

Edit the `:root` CSS variables in the variant CSS file. All buttons, links, focus
rings, and backgrounds will update automatically because the base CSS references
these variables.

Example — making doer-visa use orange:
```css
/* src/login/doer-visa.css */
:root {
    --doer-primary: #ea580c;
    --doer-primary-hover: #c2410c;
    --doer-primary-ring: rgba(234, 88, 12, 0.2);
    --doer-bg-gradient: linear-gradient(135deg, #c2410c 0%, #7c2d12 50%, #1c1917 100%);
    --doer-accent: #f97316;
}
```


### 12.5 Add Custom Fonts

**Step 1:** Place font files in `public/fonts/` or use a Google Fonts import.

**Step 2:** Add the `@font-face` or `@import` to `doer-base.css`:

```css
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
```

Or for self-hosted:
```css
@font-face {
    font-family: 'Inter';
    src: url('/fonts/Inter-Regular.woff2') format('woff2');
    font-weight: 400;
    font-style: normal;
    font-display: swap;
}
```

**Step 3:** The `font-family` in `doer-base.css` already references `'Inter'`, so
it will automatically pick up the loaded font.


### 12.6 Add Environment Variables

You can pass runtime configuration from Keycloak to your theme via environment
variables (set on the Keycloak process).

**Step 1:** Declare variables in `vite.config.ts`:
```ts
keycloakify({
    themeName: ["doer-visa", "doer-admin"],
    accountThemeImplementation: "none",
    environmentVariables: [
        { name: "DOER_API_URL", default: "http://localhost:9080" },
        { name: "DOER_SUPPORT_EMAIL", default: "support@doer.com" }
    ]
})
```

**Step 2:** Regenerate types:
```bash
npx keycloakify update-kc-gen
```

**Step 3:** Access in your React code:
```ts
const apiUrl = kcContext.properties.DOER_API_URL;
```

**Step 4:** Set when running Keycloak:
```bash
export DOER_API_URL="https://api.doer.com"
kc.sh start-dev
```

---

## 13. Troubleshooting

### Theme doesn't appear in Keycloak's dropdown

- Did you run `kc.sh build` after copying the JAR to `providers/`?
- Did you restart Keycloak after running `kc.sh build`?
- Check the JAR was copied to the correct directory:
  `keycloak-26.5.4/providers/doer-themes.jar`

### Theme appears but login looks unchanged

- Clear your browser cache (Ctrl+Shift+R) — Keycloak aggressively caches theme
  resources.
- Verify the client has the correct `login_theme` attribute set (not the realm-level
  theme, which is a different setting).
- Check the HTML source of the login page — look for `resourcesPath` containing
  your theme name (e.g., `/resources/.../login/doer-visa`).

### `kc.gen.tsx` has wrong theme names

Run `npx keycloakify update-kc-gen` after changing `themeName` in `vite.config.ts`.

### Build fails with Maven errors

- Ensure Maven is installed: `mvn --version` (or `~/.local/bin/mvn --version`)
- Ensure Java is available: `java --version`
- Add Maven to PATH: `export PATH="$HOME/.local/bin:$PATH"`

### TypeScript errors after ejecting a page

Ejected components may reference types that need to be imported. Check the imports
at the top of the ejected file and ensure all referenced types are available.

### CSS changes not taking effect

- PatternFly's specificity is high. Use `!important` to override, or increase your
  selector specificity.
- If `doUseDefaultCss={true}`, Keycloak's CSS loads first. Your CSS must override it.
- Check that your CSS file is actually imported (verify the `import` statement in
  `KcPage.tsx`).

---

## 14. Reference: Keycloak Pages

These are the pages Keycloak can render. Each has a `pageId` that appears in
`kcContext.pageId`:

| Page ID | When It's Shown |
|---------|-----------------|
| `login.ftl` | Main login form (username + password) |
| `login-username.ftl` | Username-only step (for 2-step login flows) |
| `login-password.ftl` | Password-only step |
| `register.ftl` | Self-registration form |
| `login-reset-password.ftl` | "Forgot password" — enter email |
| `login-verify-email.ftl` | "Check your email" confirmation |
| `login-otp.ftl` | Enter OTP/TOTP code (MFA) |
| `login-config-totp.ftl` | Set up TOTP authenticator app |
| `login-update-password.ftl` | Forced password change |
| `login-update-profile.ftl` | Forced profile update |
| `login-idp-link-confirm.ftl` | Confirm linking to social identity provider |
| `login-page-expired.ftl` | Session expired |
| `logout-confirm.ftl` | Confirm logout |
| `error.ftl` | Generic error page |
| `info.ftl` | Generic info page |
| `terms.ftl` | Terms and conditions acceptance |
| `select-authenticator.ftl` | Choose authentication method |
| `webauthn-authenticate.ftl` | WebAuthn/passkey authentication |
| `webauthn-register.ftl` | WebAuthn/passkey registration |

You can eject and customize any of these individually.

---

## 15. Reference: kcContext

The `kcContext` object is the bridge between Keycloak and your React code. Its shape
depends on which page is being rendered.

### Properties available on ALL pages

| Property | Type | Description |
|----------|------|-------------|
| `kcContext.pageId` | `string` | Which page: `"login.ftl"`, `"register.ftl"`, etc. |
| `kcContext.themeName` | `ThemeName` | Which variant: `"doer-visa"` or `"doer-admin"` |
| `kcContext.themeType` | `string` | Always `"login"` for login themes |
| `kcContext.locale` | `object` | Current locale info + list of supported locales |
| `kcContext.realm` | `object` | Realm settings (name, registration enabled, etc.) |
| `kcContext.url` | `object` | URLs for login action, registration, password reset, etc. |
| `kcContext.message` | `object \| undefined` | Error or success message to display |
| `kcContext.isAppInitiatedAction` | `boolean` | Whether this is a required action |
| `kcContext.properties` | `Record<string, string>` | Environment variables |
| `kcContext.resourcesPath` | `string` | Base URL for theme static assets |

### Properties specific to `login.ftl`

| Property | Type | Description |
|----------|------|-------------|
| `kcContext.social.providers` | `array` | List of social identity providers (Google, GitHub, etc.) |
| `kcContext.login.username` | `string` | Pre-filled username (e.g., from a previous attempt) |
| `kcContext.login.rememberMe` | `boolean` | Whether "remember me" was checked |
| `kcContext.registrationDisabled` | `boolean` | Whether to hide the registration link |
| `kcContext.usernameHidden` | `boolean` | Whether to hide the username field |

For the full type definitions, explore:
```
node_modules/keycloakify/src/login/KcContext/
```

---

## 16. Reference: CSS Selectors

Key CSS selectors in Keycloak's login pages (useful when writing custom CSS):

| Selector | Element |
|----------|---------|
| `body.kc-login` | The `<body>` tag on all login pages |
| `#kc-header-wrapper` | Header area (logo/title) |
| `#kc-page-title` | Page title text ("Sign in to...") |
| `.card-pf` | The login card/box |
| `#kc-login` | Main login container |
| `#kc-form` | The form element |
| `#kc-form-login` | Login form specifically |
| `.form-group` | Each form field group (label + input) |
| `.form-control` | Input fields |
| `.btn-primary` | Primary submit button |
| `.btn-default` | Secondary buttons |
| `#kc-registration` | "Don't have an account?" link area |
| `#kc-info-wrapper` | Footer info area |
| `.alert-error` | Error message banner |
| `.alert-success` | Success message banner |
| `.kc-social-provider-container` | Social login buttons container |
| `.kc-social-provider` | Individual social login button |
| `.kc-social-icon` | Social provider icon |
| `#kc-locale-dropdown` | Language selector |

---

## Quick Reference Card

```
DEVELOP         npm run storybook           Preview pages with mock data
                npm run dev                 Vite dev server (needs mock kcContext)

BUILD           npm run build-keycloak-theme   Compile → bundle → package JAR

DEPLOY          bash ../../scripts/deploy-theme.sh   Build + copy + kc.sh build
                Then restart Keycloak

ADD VARIANT     1. Edit vite.config.ts (themeName array)
                2. npx keycloakify update-kc-gen
                3. Create src/login/doer-{name}.css
                4. Add case in KcPage.tsx switch
                5. Add translations in i18n.ts
                6. Build and deploy

EJECT PAGE      npx keycloakify eject-page
                Then add a case in KcPage.tsx switch for the pageId

REGEN TYPES     npx keycloakify update-kc-gen

ADD STORY       npx keycloakify add-story
```
